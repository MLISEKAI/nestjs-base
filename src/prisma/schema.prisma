generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserBasicRole {
  admin
  user
  guest
}

enum ProviderEnum {
  anonymous
  phone
  facebook
  microsoft
  google
  apple
  password
}

// USER BASE MODEL
model ResUser {
  id         String    @id @default(uuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?
  is_deleted Boolean   @default(false)

  // Base
  union_id   String        @unique
  role       UserBasicRole @default(guest)
  nickname   String
  is_blocked Boolean       @default(false)

  bio      String?
  avatar   String?
  gender   String?
  birthday DateTime?

  // --- Relations ---
  associates   ResAssociate[]
  albums       ResAlbum[]
  followers    ResFollow[]    @relation("Followers")
  following    ResFollow[]    @relation("Following")
  friendsA     ResFriend[]    @relation("FriendsA")
  friendsB     ResFriend[]    @relation("FriendsB")
  messagesSent ResMessage[]   @relation("MessagesSent")
  messagesRecv ResMessage[]   @relation("MessagesRecv")
  giftsSent    ResGift[]      @relation("GiftsSent")
  giftsRecv    ResGift[]      @relation("GiftsRecv")

  wallet     ResWallet?
  vipStatus  ResVipStatus?
  storeItems ResStoreItem[]
  tasks      ResTask[]
  clans      ResUserClan[]

  loveSpace          ResLoveSpace?
  feedbacks          ResFeedback[]
  location          ResLocation?
  contributions      ResContribution?
  interests          ResInterest[]
  supporters         ResSupporter[]
  roomStatus         ResRoomStatus?
  post               ResPost[]
  giftMilestones     ResGiftMilestone[]
  walletTransactions ResWalletTransaction[]
  inventories        ResInventory[]

  supportedUsers       ResSupporter[]   @relation("SupportedUser")
  supportersFrom       ResSupporter[]   @relation("SupporterUser")
  referralsAsReferrer  ResReferral[]    @relation("Referrer")
  referralsAsReferred  ResReferral[]    @relation("Referred")
  profileViewsAsViewer ResProfileView[] @relation("Viewer")
  profileViewsAsTarget ResProfileView[] @relation("Target")
  relationships        ResRelationship[] @relation("UserRelationships")
  relationshipsRelated ResRelationship[] @relation("UserRelated")

  @@index([union_id, deleted_at])
  @@index([union_id])
  @@map("res_user")
}

// ASSOCIATE
model ResAssociate {
  id         String    @id @default(uuid())
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  deleted_at DateTime?
  is_deleted Boolean   @default(false)

  // Base
  user_id      String
  email        String?
  phone_number String?
  ref_id       String
  hash         String?
  provider     ProviderEnum

  // Relation
  user ResUser @relation(fields: [user_id], references: [id])

  @@index([ref_id])
  @@index([user_id])
  @@map("res_associate")
}

// Album
model ResAlbum {
  id         String   @id @default(uuid())
  created_at DateTime @default(now())
  title      String
  user_id    String
  image_url  String

  user   ResUser         @relation(fields: [user_id], references: [id])
  photos ResAlbumPhoto[]

  @@index([user_id])
  @@map("res_album")
}

// ALBUM PHOTO
model ResAlbumPhoto {
  id         String   @id @default(uuid())
  album_id   String
  image_url  String
  created_at DateTime @default(now())

  album ResAlbum @relation(fields: [album_id], references: [id])

  @@index([album_id])
  @@map("res_album_photo")
}

// FOLLOW
model ResFollow {
  id         String   @id @default(uuid())
  created_at DateTime @default(now())

  follower_id  String
  following_id String

  follower  ResUser @relation("Followers", fields: [follower_id], references: [id])
  following ResUser @relation("Following", fields: [following_id], references: [id])

  @@unique([follower_id, following_id])
  @@index([follower_id])
  @@index([following_id])
  @@map("res_follow")
}

// FRIEND
model ResFriend {
  id         String   @id @default(uuid())
  created_at DateTime @default(now())

  user_a_id String
  user_b_id String

  userA ResUser @relation("FriendsA", fields: [user_a_id], references: [id])
  userB ResUser @relation("FriendsB", fields: [user_b_id], references: [id])

  @@unique([user_a_id, user_b_id])
  @@map("res_friend")
}

// MESSAGE (TIN NHẮN)
model ResMessage {
  id         String   @id @default(uuid())
  created_at DateTime @default(now())

  sender_id   String
  receiver_id String
  content     String

  sender   ResUser @relation("MessagesSent", fields: [sender_id], references: [id])
  receiver ResUser @relation("MessagesRecv", fields: [receiver_id], references: [id])

  @@index([sender_id])
  @@index([receiver_id])
  @@map("res_message")
}

// GIFT (QUÀ TẶNG)
model ResGift {
  id           String   @id @default(uuid())
  created_at   DateTime @default(now())
  sender_id    String
  receiver_id  String
  gift_item_id String
  message      String?
  quantity     Int      @default(1)

  sender   ResUser     @relation("GiftsSent", fields: [sender_id], references: [id], onDelete: Cascade)
  receiver ResUser     @relation("GiftsRecv", fields: [receiver_id], references: [id], onDelete: Cascade)
  giftItem ResGiftItem @relation(fields: [gift_item_id], references: [id], onDelete: Cascade)

  @@index([sender_id])
  @@index([receiver_id])
  @@map("res_gift")
}

model ResGiftCategory {
  id           String        @id @default(uuid())
  name         String
  resGiftItems ResGiftItem[]

  @@map("res_gift_category")
}

model ResGiftItem {
  id          String  @id @default(uuid())
  category_id String
  name        String
  image_url   String?
  price       Decimal @db.Decimal(10, 2)
  type        String? // normal | vip | event

  gifts ResGift[]

  category ResGiftCategory @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@map("res_gift_item")
}

model ResGiftMilestone {
  id          String   @id @default(uuid())
  user_id     String
  milestone   Int
  current     Int      @default(0)
  reward_name String?
  icon_url    String?
  is_unlocked Boolean  @default(false)
  created_at  DateTime @default(now())
  user        ResUser  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("res_gift_milestone")
}

// WALLET
model ResWallet {
  id           String                 @id @default(uuid())
  user_id      String                 @unique
  balance      Decimal                @default(0) @db.Decimal(12, 2)
  currency     String                 @default("gem")
  created_at   DateTime               @default(now())
  updated_at   DateTime               @updatedAt
  transactions ResWalletTransaction[]
  user         ResUser                @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("res_wallet")
}

enum WalletTransactionType {
  deposit
  withdraw
  gift
  convert
}

enum WalletTransactionStatus {
  pending
  success
  failed
}

enum WalletCurrency {
  gem
  vex
}

model ResWalletTransaction {
  id             String                  @id @default(uuid())
  wallet_id      String
  user_id        String
  type           WalletTransactionType
  amount         Decimal                 @db.Decimal(12, 2)
  balance_before Decimal?                @db.Decimal(12, 2)
  balance_after  Decimal?                @db.Decimal(12, 2)
  status         WalletTransactionStatus @default(pending)
  reference_id   String?
  created_at     DateTime                @default(now())

  wallet ResWallet @relation(fields: [wallet_id], references: [id], onDelete: Cascade)
  user   ResUser   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([wallet_id])
  @@index([created_at])
  @@map("res_wallet_transaction")
}

// VIP STATUS
model ResVipStatus {
  id      String    @id @default(uuid())
  user_id String    @unique
  is_vip  Boolean   @default(false)
  expiry  DateTime?
  user    ResUser   @relation(fields: [user_id], references: [id])

  @@map("res_vip_status")
}

// STORE ITEM
model ResStoreItem {
  id      String   @id @default(uuid())
  name    String
  price   Decimal
  user_id String?
  user    ResUser? @relation(fields: [user_id], references: [id])

  @@map("res_store_item")
}

// TASKS
model ResTask {
  id      String  @id @default(uuid())
  user_id String
  title   String
  is_done Boolean @default(false)
  user    ResUser @relation(fields: [user_id], references: [id])

  @@map("res_task")
}

// INVENTORY
model ResInventory {
  id       String @id @default(uuid())
  user_id  String
  item_id  String
  quantity Int    @default(1)

  user ResUser @relation(fields: [user_id], references: [id], onDelete: Cascade)
  item ResItem @relation(fields: [item_id], references: [id], onDelete: Cascade)

  @@unique([user_id, item_id])
  @@map("res_inventory")
}

model ResItem {
  id          String         @id @default(uuid())
  name        String
  type        String?
  rarity      String?
  price       Decimal?       @db.Decimal(10, 2)
  image_url   String?
  inventories ResInventory[]

  @@map("res_item")
}

// CLAN
model ResClan {
  id      String        @id @default(uuid())
  name    String
  members ResUserClan[]

  @@map("res_clan")
}

model ResUserClan {
  id      String  @id @default(uuid())
  user_id String
  clan_id String
  rank    String
  user    ResUser @relation(fields: [user_id], references: [id])
  clan    ResClan @relation(fields: [clan_id], references: [id])

  @@map("res_user_clan")
}

// REFERRAL
model ResReferral {
  id            String   @id @default(uuid())
  referrer_id   String
  referred_id   String
  reward_amount Int      @default(0)
  created_at    DateTime @default(now())
  referrer      ResUser  @relation("Referrer", fields: [referrer_id], references: [id])
  referred      ResUser  @relation("Referred", fields: [referred_id], references: [id])

  @@unique([referrer_id, referred_id])
  @@map("res_referral")
}

// PROFILE VIEWS
model ResProfileView {
  id             String   @id @default(uuid())
  viewer_id      String
  target_user_id String
  viewed_at      DateTime @default(now())
  viewer         ResUser  @relation("Viewer", fields: [viewer_id], references: [id])
  target_user    ResUser  @relation("Target", fields: [target_user_id], references: [id])

  @@index([viewer_id])
  @@index([target_user_id])
  @@map("res_profile_view")
}

//New
// Love Space
model ResLoveSpace {
  id         String   @id @default(uuid())
  user_id    String   @unique
  bio        String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user ResUser @relation(fields: [user_id], references: [id])

  @@map("res_love_space")
}

// Company Info
model ResCompany {
  id         String   @id @default(uuid())
  name       String
  address    String?
  phone      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("res_company")
}

// Support Info
model ResSupportInfo {
  id         String   @id @default(uuid())
  email      String
  phone      String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("res_support_info")
}

// Help Article
model ResHelpArticle {
  id         String   @id @default(uuid())
  title      String
  content    String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("res_help_article")
}

// Feedback
model ResFeedback {
  id         String   @id @default(uuid())
  user_id    String
  content    String
  created_at DateTime @default(now())
  user       ResUser  @relation(fields: [user_id], references: [id])

  @@map("res_feedback")
}

// Location
model ResLocation {
  id         String   @id @default(uuid())
  user_id    String   @unique
  lat        Float
  lng        Float
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       ResUser  @relation(fields: [user_id], references: [id])

  @@map("res_location")
}

// Contribution
model ResContribution {
  id         String   @id @default(uuid())
  user_id    String   @unique
  points     Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       ResUser  @relation(fields: [user_id], references: [id])

  @@map("res_contribution")
}

// Interest
model ResInterest {
  id      String  @id @default(uuid())
  user_id String
  name    String
  user    ResUser @relation(fields: [user_id], references: [id])

  @@map("res_interest")
}

// Supporter
model ResSupporter {
  id           String @id @default(uuid())
  user_id      String
  supporter_id String
  amount       Int

  user      ResUser @relation("SupportedUser", fields: [user_id], references: [id], onDelete: Cascade)
  supporter ResUser @relation("SupporterUser", fields: [supporter_id], references: [id], onDelete: Cascade)

  @@unique([user_id, supporter_id])
  @@map("res_supporter")
}

// Relationship
model ResRelationship {
  id              String  @id @default(uuid())
  user_id         String
  related_user_id String
  type            String

  user         ResUser @relation("UserRelationships", fields: [user_id], references: [id])
  related_user ResUser @relation("UserRelated", fields: [related_user_id], references: [id])

  @@map("res_relationship")
}

// Room Status
model ResRoomStatus {
  id      String  @id @default(uuid())
  user_id String  @unique
  status  String
  user    ResUser @relation(fields: [user_id], references: [id])

  @@map("res_room_status")
}

model ResPost {
  id         String   @id @default(uuid())
  user_id    String
  content    String
  created_at DateTime @default(now())

  user ResUser @relation(fields: [user_id], references: [id])

  @@map("res_post")
  @@index([user_id])
}
